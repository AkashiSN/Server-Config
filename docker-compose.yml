version: "3.8"

services:
  mirakurun:
    image: chinachu/mirakurun
    cap_add:
      - SYS_ADMIN
      - SYS_NICE
    environment:
      TZ: Asia/Tokyo
      # LOG_LEVEL: "3"
      # DEBUG: "true"
    devices:
      - /dev/bus:/dev/bus
      - /dev/dvb:/dev/dvb
    volumes:
      - ./mirakurun/run/:/var/run/
      - ./mirakurun/opt/:/opt/
      - ./mirakurun/config/:/app-config/
      - ./mirakurun/data/:/app-data/
    networks:
      - mynet
    restart: always
    logging:
      driver: json-file
      options:
        max-file: "1"
        max-size: 10m

  mariadb_epgstation:
    image: mariadb:10.5
    volumes:
      - mariadb_epgstation:/var/lib/mysql
    env_file:
      - .mariadb_epgstation.env
    environment:
      TZ: "Asia/Tokyo"
    networks:
      - mynet
    command: mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci --performance-schema=false --expire_logs_days=1
    restart: always
    logging:
      options:
        max-size: "10m"
        max-file: "3"

  epgstation:
    build:
      context: epgstation
      args:
        - FFMPEG_IMAGE=${FFMPEG_IMAGE}
    runtime: nvidia
    env_file:
      - .mariadb_epgstation.env
    volumes:
        - /etc/localtime:/etc/localtime:ro
        - ./epgstation/config:/app/config
        - ./epgstation/data:/app/data
        - ./epgstation/thumbnail:/app/thumbnail
        - ./epgstation/logs:/app/logs
        - ${RECODED_PATH}:/app/recorded
    environment:
      TZ: "Asia/Tokyo"
    depends_on:
      - mirakurun
      - mariadb_epgstation
    #user: "1000:1000"
    networks:
      - mynet
    command: /bin/sh -c "envsubst '$$MYSQL_USER $$MYSQL_PASSWORD $$MYSQL_DATABASE' < /app/config/config.json.template > /app/config/config.json && npm start"
    restart: always

  auth-proxy:
    build:
      context: auth-proxy
    environment:
      TZ: "Asia/Tokyo"
    networks:
      - mynet
    command: -clientID ${SLACK_CLIENT_ID}
    restart: always

  nginx:
    image: nginx:mainline
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - ./nginx/conf.d:/etc/nginx/conf.d 
    environment:
      TZ: "Asia/Tokyo"
      DOMAIN: ${DOMAIN}
    depends_on:
      - epgstation
      - auth-proxy
    networks:
      - mynet
    command: /bin/sh -c "envsubst '$$DOMAIN' < /etc/nginx/conf.d/tv.conf.template > /etc/nginx/conf.d/tv.conf && nginx -g 'daemon off;'"
    restart: always

  openvpn:
    build:
      context: openvpn
    cap_add: 
      - NET_ADMIN
    volumes:
      - ./openvpn:/opt/openvpn
    environment: 
      TZ: "Asia/Tokyo"
    networks:
      - mynet
    restart: always
  
  sslh:
    build:
      context: sslh
    cap_add:
      - NET_ADMIN
    volumes:
      - ./sslh:/opt/sslh
    environment:
      TZ: "Asia/Tokyo"
    depends_on:
      - nginx
      - openvpn
    ports:
      - "443:443"
    networks:
      - mynet
    restart: always

volumes:
  mariadb_epgstation:
    driver: local

networks:
  mynet:
    driver: bridge
